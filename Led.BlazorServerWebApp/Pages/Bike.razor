@page "/bike"
@using static Led.BlazorServerWebApp.Components.Buttons.TurnSignalButton
@inject Hub75Matrix matrix

<h1>Bike</h1>

<div class="turn-signals">
    <TurnSignalButton 
        Direction=@TurnSignal.Left 
        OnCallback=@((isOn) => matrix.DrawImage(Media.Image.ArrowLeft.GetRelativePathWeb()))
        OffCallback=@((isOn) => matrix.Clear())
        OnDuration=@settings.TurnSignal.OnDuration
        OffDuration=@settings.TurnSignal.OffDuration/>
    <TurnSignalButton 
        Direction=@TurnSignal.Right 
        OnCallback=@((isOn) => matrix.DrawImage(Media.Image.ArrowRight.GetRelativePathWeb()))
        OffCallback=@((isOn) => matrix.Clear())
        OnDuration=@settings.TurnSignal.OnDuration
        OffDuration=@settings.TurnSignal.OffDuration/>
</div>

<PowerButton @bind-IsOn=@matrix.IsOn>@MaterialIcons.Lightbulb</PowerButton>
<PowerButton IsOn=@isRecording OnToggle="ToggleRecording">@MaterialIcons.VideoCamera</PowerButton>
<ImageCard Src=@Media.Image.Bike.GetRelativePath() OnClick=@((src) => RenderImage(Media.Image.Bike))/>

@code {
    private ApplicationSettings settings = ApplicationSettings.Load();

    private void RenderImage(Media.Image image)
    {
        matrix.CancelCurrentTask(false);
        matrix.Clear();

        using (var imageFile = Image.Load<Rgb24>(image.GetRelativePathWeb()))
        {
            matrix.DrawImage(imageFile, image.GetRelativePathWeb());
        }
    }

    private bool isRecording = false;
    private System.Diagnostics.Process? recordingProcess;

    private void ToggleRecording()
    {
        if (isRecording)
        {
            if (recordingProcess != null && !recordingProcess.HasExited)
            {
                isRecording = false;
                recordingProcess.Kill();
                recordingProcess.Dispose();
            }
        }
        else
        {
            isRecording = true;
            Task.Run(
                () =>
                {
                    while (isRecording)
                    {
                        string path = "/home/pi/Videos/Recordings/";
                        string currentDateTime = DateTime.Now.ToString("yyyy-MM-dd HHmmss");
                        int rotation = 90;
                        int timeoutMinutes = 30;

                        string command = $"raspivid -o {path}{currentDateTime}.h264 -t {timeoutMinutes * 60 * 1000} -rot {rotation}  -vs --nopreview";

                        recordingProcess = new();
                        recordingProcess.StartInfo.FileName = "/bin/bash";
                        recordingProcess.StartInfo.Arguments = $"-c \"{command}\"";
                        recordingProcess.StartInfo.UseShellExecute = false;
                        recordingProcess.StartInfo.RedirectStandardOutput = true;
                        recordingProcess.StartInfo.RedirectStandardError = true;
                        recordingProcess.Start();
                        recordingProcess.WaitForExit();
                    }
                }
            );
        }  
    }
}
